<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Upload Product | Bonnie Lass Florals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../auth.css">
  <!-- Theme Loader - Load early to minimize FOUC -->
  <script src="../theme-loader.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <img src="../img/logo.png" alt="Bonnie Lass Florals Logo" style="height:48px;vertical-align:middle;margin-right:12px;">
      Bonnie Lass Florals
    </div>
    <nav>
      <a href="../index.html">Home</a>
      <a href="../about.html">About</a>
      <a href="../shop.html">Shop</a>
      <a href="../gallery.html">Gallery</a>
      <a href="../contact.html">Contact</a>
    </nav>
  </header>

  <main style="max-width:1000px;margin:2rem auto;padding:1rem;">
    <div style="font-size:0.95rem;color:#666;margin-bottom:0.75rem;">
      <a href="../index.html">Home</a>
      <span class="breadcrumb-separator">›</span>
      <a href="../profile.html">Profile</a>
      <span class="breadcrumb-separator">›</span>
      <span class="breadcrumb-current">Upload Product</span>
    </div>

    <h1>Upload New Product</h1>

    <!-- CSV Batch Upload Section -->
    <div style="background:#f8fafc; padding:1.5rem; border-radius:0.5rem; margin-bottom:1.5rem;">
      <h2 style="margin-top:0;">Batch Upload via CSV</h2>
      <p>Upload multiple products at once using a CSV file. The CSV should include columns: name, description, price, type, subcategory, stock, options (optional), image (URL)</p>
      <input type="file" id="csvFile" accept=".csv" style="margin-bottom:1rem;">
      <button type="button" id="uploadCsvBtn" style="background:#10b981;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;cursor:pointer;">Upload CSV</button>
      <div id="csv-result" style="margin-top:1rem;"></div>
    </div>

    <!-- Single Product Upload Form -->
    <h2>Single Product Upload</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      <label for="name">Product Name</label>
      <input type="text" id="name" name="name" required>

      <label for="description">Description</label>
      <textarea id="description" name="description" required></textarea>

      <label for="price">Price</label>
      <input type="number" id="price" name="price" step="0.01" required>

      <label for="type">Type</label>
      <select id="type" name="type" required>
        <option value="decor">Decor</option>
        <option value="food">Cottage Food</option>
      </select>

      <label for="subcategory">Subcategory</label>
      <input type="text" id="subcategory" name="subcategory">

      <label for="stock">Stock</label>
      <input type="number" id="stock" name="stock" min="1" value="1" required>

      <label for="options">Options (comma-separated)</label>
      <input type="text" id="options" name="options">

      <label for="image">Image URL</label>
      <input type="text" id="image" name="image">

      <label for="imageFile">Or upload image file</label>
      <input type="file" id="imageFile" name="imageFile" accept="image/*">

      <div style="margin-top:1rem;">
        <button type="submit" id="uploadBtn" style="background:#6e33b7;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;cursor:pointer;">Upload Product</button>
        <button type="button" id="uploadAnotherBtn" style="display:none;margin-left:8px;">Upload another</button>
      </div>
    </form>

    <div id="upload-success" style="display:none;margin-top:1rem;color:green;">Product uploaded successfully!</div>
    <div id="upload-error" style="display:none;margin-top:1rem;color:red;"></div>

    <!-- Manage Products -->
    <h2 style="margin-top:2rem;">Manage Products</h2>
    <button id="loadProductsBtn" style="background:#efefef;padding:0.5rem 0.75rem;border-radius:8px;border:1px solid #ddd;cursor:pointer;">Load All Products</button>
    <div id="products-list" style="margin-top:1rem;"></div>
  </main>

  <script src="../mobile-nav.js"></script>
  <script src="../auth.js"></script>

  <script>
    // Single product upload handler (existing behavior)
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('upload-error').style.display = 'none';
      document.getElementById('upload-success').style.display = 'none';

      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const price = parseFloat(document.getElementById('price').value);
      const type = document.getElementById('type').value;
      const subcategory = document.getElementById('subcategory').value.trim();
      const stock = parseInt(document.getElementById('stock').value, 10) || 1;
      const options = document.getElementById('options').value;
      const image = document.getElementById('image').value;

      const form = new FormData();
      form.append('name', name);
      form.append('description', description);
      form.append('price', price);
      form.append('type', type);
      form.append('subcategory', subcategory);
      form.append('stock', stock);
      form.append('options', options);
      if (document.getElementById('imageFile').files[0]) {
        form.append('image', document.getElementById('imageFile').files[0]);
      } else {
        form.append('image', image);
      }

      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          document.getElementById('upload-error').textContent = 'Please login first.';
          document.getElementById('upload-error').style.display = 'block';
          return;
        }
        const token = await user.getIdToken();

        const res = await fetch('https://bonnie-lass-florals.onrender.com/api/products', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token
          },
          body: form
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('upload-success').style.display = 'block';
          document.getElementById('upload-success').textContent = 'Product uploaded successfully!';
          document.getElementById('uploadForm').reset();
        } else {
          document.getElementById('upload-error').textContent = data.error || 'Upload failed.';
          document.getElementById('upload-error').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('upload-error').textContent = 'Upload error: ' + err.message;
        document.getElementById('upload-error').style.display = 'block';
      }
    });

    // Upload Another Product button handler
    document.getElementById('uploadAnotherBtn').addEventListener('click', function() {
      document.getElementById('uploadForm').reset();
      document.getElementById('uploadAnotherBtn').style.display = 'none';
      document.getElementById('upload-success').style.display = 'none';
    });

    // CSV Batch Upload functionality
    document.getElementById('uploadCsvBtn').addEventListener('click', async function() {
      const fileInput = document.getElementById('csvFile');
      const csvFile = fileInput.files[0];

      if (!csvFile) {
        document.getElementById('csv-result').innerHTML = '<p style="color:red;">Please select a CSV file.</p>';
        return;
      }

      document.getElementById('csv-result').innerHTML = '<p>Processing CSV...</p>';

      try {
        const text = await csvFile.text();
        // Basic cleanup and fallback parsing (keeps your original approach)
        const lines = text.split('\n').filter(line => line.trim());

        if (lines.length < 2) {
          document.getElementById('csv-result').innerHTML = '<p style="color:red;">CSV file is empty or invalid.</p>';
          return;
        }

        // Parse CSV manually (existing code)
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        const products = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].split(',');
          const product = {};

          headers.forEach((header, index) => {
            if (values[index]) {
              product[header] = values[index].trim();
            }
          });

          if (product.name || product.title) {
            products.push({
              name: product.name || product.title,
              description: product.description || '',
              price: product.price || '0',
              type: product.type || 'decor',
              subcategory: product.subcategory || '',
              stock: product.stock || product.quantity || '1',
              options: product.options || '',
              image: product.image || product.image1 || ''
            });
          }
        }

        if (products.length === 0) {
          document.getElementById('csv-result').innerHTML = '<p style="color:red;">No valid products found in CSV.</p>';
          return;
        }

        // ================= DEBUG SNIPPET START =================
        // Place this debug block right before sending the batch so you can inspect what will be sent.
        // It logs counts, sample rows, attaches the parsed array to window for ad-hoc inspection,
        // and prevents sending if client-side validation fails (or exceeds 100).
        try {
          // expose parsed products for interactive inspection
          window.__csvParsedProducts = products;

          const parsedCount = products.length;
          const validProducts = products.filter(p => {
            // basic validity: has name, description (can be empty string allowed) and price present (not empty)
            const hasName = !!(p.name && String(p.name).trim());
            const hasPrice = p.price !== undefined && String(p.price).trim() !== '';
            const hasDescription = p.description !== undefined; // server allows empty description, keep it flexible
            return hasName && hasPrice && hasDescription;
          });
          const validCount = validProducts.length;

          console.log('CSV parsed products count:', parsedCount);
          console.log('CSV valid products count (name+price present):', validCount);
          console.log('First 5 parsed products (sample):', products.slice(0, 5));
          console.log('First 5 valid products (sample):', validProducts.slice(0, 5));

          // UI feedback
          document.getElementById('csv-result').innerHTML = `<p>Parsed ${parsedCount} rows, ${validCount} valid products.</p>`;

          // Client-side safety check: don't send more than 100 items (backend limit)
          if (validCount === 0) {
            document.getElementById('csv-result').innerHTML += '<p style="color:red;">No valid products to upload.</p>';
            return;
          }
          if (validCount > 100) {
            document.getElementById('csv-result').innerHTML += '<p style="color:red;">CSV contains more than 100 valid products. Split into smaller batches.</p>';
            console.warn('CSV upload blocked: client-side found', validCount, 'valid products (limit 100).');
            return;
          }

          // Prepare payload using only valid products (so backend receives expected shape)
          var payloadProducts = validProducts;
        } catch (dbgErr) {
          console.error('CSV debug helper error:', dbgErr);
          // Fallback: send original products array if debug block fails
          var payloadProducts = products;
        }
        // ================= DEBUG SNIPPET END =================

        // Get Firebase token
        const user = firebase.auth().currentUser;
        if (!user) {
          document.getElementById('csv-result').innerHTML = '<p style="color:red;">Please login first.</p>';
          return;
        }

        const token = await user.getIdToken();

        // Send batch upload request (use payloadProducts prepared by debug block)
        const res = await fetch('https://bonnie-lass-florals.onrender.com/api/products/batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ products: payloadProducts })
        });

        // Read raw response for better debugging if server returns 400
        const raw = await res.text();
        let data;
        try {
          data = raw ? JSON.parse(raw) : {};
        } catch (err) {
          data = { error: raw };
        }

        if (res.ok) {
          let html = `<p style="color:green;">${data.message}</p>`;
          if (data.results && data.results.success && data.results.success.length > 0) {
            html += `<p><strong>Uploaded ${data.results.success.length} products:</strong></p><ul>`;
            data.results.success.forEach(item => {
              html += `<li>${item.name} (ID: ${item.id})</li>`;
            });
            html += '</ul>';
          }
          if (data.results && data.results.errors && data.results.errors.length > 0) {
            html += `<p style="color:red;"><strong>Failed ${data.results.errors.length} products:</strong></p><ul>`;
            data.results.errors.forEach(item => {
              html += `<li>Row ${item.row}: ${item.error}</li>`;
            });
            html += '</ul>';
          }
          document.getElementById('csv-result').innerHTML = html;
          fileInput.value = '';
        } else {
          // Show server-provided error (helps reveal if backend says "Batch size limited to 100 products" etc.)
          document.getElementById('csv-result').innerHTML = `<p style="color:red;">Error uploading CSV (status ${res.status}): ${data.error || raw}</p>`;
          console.error('Batch upload failed:', res.status, data || raw);
        }
      } catch (err) {
        document.getElementById('csv-result').innerHTML = `<p style="color:red;">Upload error: ${err.message}</p>`;
        console.error('CSV upload error:', err);
      }
    });

    // Load Products functionality
    document.getElementById('loadProductsBtn').addEventListener('click', async function() {
      const list = document.getElementById('products-list');
      list.innerHTML = '<p>Loading products...</p>';
      try {
        const res = await fetch('https://bonnie-lass-florals.onrender.com/api/products');
        const products = await res.json();
        if (res.ok && products.length > 0) {
          let html = '<table style="width:100%; border-collapse:collapse; margin-top:1rem;">';
          html += '<thead><tr style="background:#f0f0f0;">';
          html += '<th style="padding:0.5rem; text-align:left;">Name</th>';
          html += '<th style="padding:0.5rem; text-align:left;">Price</th>';
          html += '<th style="padding:0.5rem; text-align:left;">Stock</th>';
          html += '<th style="padding:0.5rem; text-align:left;">Type</th>';
          html += '<th style="padding:0.5rem; text-align:left;">Actions</th>';
          html += '</tr></thead><tbody>';
          products.forEach(p => {
            html += `<tr>`;
            html += `<td style="padding:0.5rem;border-top:1px solid #eee;">${p.name}</td>`;
            html += `<td style="padding:0.5rem;border-top:1px solid #eee;">${p.price}</td>`;
            html += `<td style="padding:0.5rem;border-top:1px solid #eee;">${p.stock}</td>`;
            html += `<td style="padding:0.5rem;border-top:1px solid #eee;">${p.type}</td>`;
            html += `<td style="padding:0.5rem;border-top:1px solid #eee;">`;
            html += `<button onclick="window.editProduct('${p._id}')" style="margin-right:6px;">Edit</button>`;
            html += `<button onclick="window.deleteProduct('${p._id}')" style="background:#f87171;color:#fff;">Delete</button>`;
            html += `</td></tr>`;
          });
          html += '</tbody></table>';
          list.innerHTML = html;
        } else {
          list.innerHTML = '<p>No products found.</p>';
        }
      } catch (err) {
        list.innerHTML = `<p style="color:red;">Error loading products: ${err.message}</p>`;
      }
    });

    // Placeholder edit/delete functions (implementation elsewhere)
    window.editProduct = function(id) {
      alert('Edit not implemented in this snippet. Open product in editor for id: ' + id);
    };
    window.deleteProduct = async function(id) {
      if (!confirm('Delete product? This action cannot be undone.')) return;
      try {
        const user = firebase.auth().currentUser;
        if (!user) { alert('Please login first'); return; }
        const token = await user.getIdToken();
        const res = await fetch('https://bonnie-lass-florals.onrender.com/api/products/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.ok) {
          alert('Deleted.');
          document.getElementById('loadProductsBtn').click();
        } else {
          const text = await res.text();
          alert('Delete failed: ' + text);
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    };
  </script>
</body>
</html>
