<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin â€” Upload Product | Bonnie Lass Florals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico">
  <!-- Preconnect to external domains for faster resource loading -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://bonnie-lass-florals.onrender.com" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <!-- Preload critical CSS -->
  <link rel="preload" href="/styles.css" as="style">
  <!-- Root-absolute asset paths so this works from /admin/ and root -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/auth.css">
  <!-- Ensure relative links resolve from site root (helps copied header work) -->
  <base href="/" />
  <!-- Theme Loader - Load early to minimize FOUC -->
  <script src="/theme-loader.js"></script>
  <!-- Admin Guard - Must be loaded before Firebase to prevent unauthorized access -->
  <script src="/admin-guard.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script src="/firebase-config.js"></script>
  <script>
    initFirebase();
  </script>
  <!-- Input History Feature -->
  <script src="/input-history.js"></script>

  <style>
    /* Small admin page tweaks for layout */
    main { max-width: 1000px; margin: 2rem auto; padding: 1rem; }
    header { display:flex; align-items:center; gap:1rem; padding:1rem; border-bottom:1px solid #eee; }
    header .logo { display:flex; align-items:center; gap:12px; font-weight:bold; color:#4b2f6f; }
    header nav { display:flex; gap:1rem; margin-left:1rem; }
    #profileCircleContainer { margin-left:auto; position:relative; }
    #profileDropdown { display:none; position:absolute; right:0; top:48px; background:#fff; border:1px solid #ddd; border-radius:6px; min-width:180px; box-shadow:0 6px 18px rgba(0,0,0,0.08); z-index:50; }
    #profileDropdown a, #profileDropdown button { display:block; width:100%; padding:0.5rem 0.75rem; color:#333; text-decoration:none; background:none; border:none; text-align:left; cursor:pointer; }
    #profileDropdown a:hover, #profileDropdown button:hover { background:#f6f6f6; }
    .admin-section { background:#f8fafc; padding:1.25rem; border-radius:8px; margin-bottom:1.25rem; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:0.5rem; margin-top:0.25rem; border-radius:6px; border:1px solid #ddd; }
    button { cursor:pointer; }
    .product-card img { max-width:100%; display:block; }

  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/img/logo.png" alt="Bonnie Lass Florals Logo" style="height:48px;vertical-align:middle;">
      Bonnie Lass Florals
    </div>

    <nav>
      <a href="/index.html">Home</a>
      <a href="/about.html">About</a>
      <a href="/shop.html">Shop</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/contact.html">Contact</a>
    </nav>

    <!-- Profile circle + dropdown -->
    <div id="profileCircleContainer">
      <img id="profileCircle" src="/img/default-avatar.png" alt="Profile" style="height:40px;width:40px;border-radius:50%;cursor:pointer;" />
      <div id="profileDropdown">
        <div id="userInfoDropdown" style="padding:0.75rem;border-bottom:1px solid #f0f0f0;"></div>
        <a href="/profile.html">Profile</a>
        <a href="/orders.html">Orders</a>
        <a id="adminOrdersLink" href="/admin/orders.html" style="display:none;">All Orders (Admin)</a>
        <a id="uploadProductLink" href="/admin/upload.html" style="display:none;">Upload Product</a>
        <a id="paletteLink" href="/admin/palette.html" style="display:none;">Palette Editor</a>
        <a id="messagesLink" href="/admin/messages.html" style="display:none;">Messages</a>
        <button id="logoutMenu">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div style="font-size:0.95rem;color:#666;margin-bottom:0.75rem;">
      <a href="/index.html">Home</a> <span style="color:#bbb;margin:0 8px;">â€º</span>
      <a href="/profile.html">Profile</a> <span style="color:#bbb;margin:0 8px;">â€º</span>
      <span style="font-weight:600;">Upload Product</span>
    </div>

    <h1>Upload New Product</h1>

    <!-- CSV Batch Upload Section -->
    <section class="admin-section" aria-labelledby="csv-title">
      <h2 id="csv-title" style="margin-top:0;">Batch Upload via CSV</h2>
      <p style="margin:0 0 0.5rem 0;">Upload multiple products at once using a CSV. Columns: name, description, price, type, subcategory, stock, options, image</p>
      <input type="file" id="csvFile" accept=".csv" style="margin-bottom:0.75rem;">
      <div>
        <button id="uploadCsvBtn" style="background:#10b981;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;">Upload CSV</button>
      </div>
      <div id="csv-result" style="margin-top:1rem;"></div>
    </section>

    <!-- Single Product Upload Form -->
    <section>
      <h2>Single Product Upload</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="name">Product Name</label>
        <input type="text" id="name" name="name" required data-history="product_name">

        <label for="description">Description</label>
        <textarea id="description" name="description" required rows="4" data-history="product_description"></textarea>

        <label for="price">Price</label>
        <input type="number" id="price" name="price" step="0.01" required>

        <label for="type">Type</label>
        <select id="type" name="type" required>
          <option value="decor">Handmade Crafts</option>
          <option value="food">Cottage Food</option>
        </select>

        <label for="subcategory">Subcategory</label>
        <input type="text" id="subcategory" name="subcategory" data-history="product_subcategory">

        <label for="stock">Stock</label>
        <input type="number" id="stock" name="stock" min="0" value="1" required>

        <label for="options">Options (comma-separated)</label>
        <input type="text" id="options" name="options" data-history="product_options">

        <label for="productGroup">Product Group (Optional)</label>
        <input type="text" id="productGroup" name="productGroup" list="productGroupList" placeholder="e.g., Sauces, Jams, Wreaths" data-history="product_group">
        <datalist id="productGroupList"></datalist>
        <p style="margin:0.25rem 0 0 0;color:#6b7280;font-size:0.85rem;">Group similar products together (e.g., different sauce flavors). Leave blank for standalone product.</p>

        <!-- Extended Details Section -->
        <div style="margin-top:1.5rem;padding:1rem;background:#f9fafb;border-radius:8px;border:2px solid #e5e7eb;">
          <h3 style="margin:0 0 1rem 0;color:#4b2f6f;font-size:1.1rem;">Extended Details (Optional)</h3>
          <p style="margin:0 0 1rem 0;color:#6b7280;font-size:0.9rem;">Add detailed information about the product. Useful for ingredients, recipes, care instructions, etc.</p>
          
          <label for="ingredients">Ingredients</label>
          <textarea id="ingredients" name="ingredients" rows="2" placeholder="List of ingredients (for food items)" data-history="product_ingredients"></textarea>
          
          <label for="allergens">Allergen Information</label>
          <input type="text" id="allergens" name="allergens" placeholder="e.g., Contains nuts, dairy" data-history="product_allergens">
          
          <label for="nutritionalInfo">Nutritional Information</label>
          <textarea id="nutritionalInfo" name="nutritionalInfo" rows="3" placeholder="Per serving: calories, fat, protein, etc." data-history="product_nutritional"></textarea>
          
          <label for="recipe">Recipe / Usage Instructions</label>
          <textarea id="recipe" name="recipe" rows="3" placeholder="How to use or prepare this product" data-history="product_recipe"></textarea>
          
          <label for="careInstructions">Care Instructions</label>
          <textarea id="careInstructions" name="careInstructions" rows="2" placeholder="How to care for this product" data-history="product_care"></textarea>
          
          <label for="dimensions">Dimensions</label>
          <input type="text" id="dimensions" name="dimensions" placeholder="e.g., 12in x 8in x 6in" data-history="product_dimensions">
          
          <label for="materials">Materials</label>
          <input type="text" id="materials" name="materials" placeholder="Materials used in this product" data-history="product_materials">
          
          <label for="weight">Weight</label>
          <input type="text" id="weight" name="weight" placeholder="e.g., 2 lbs, 500g" data-history="product_weight">
          
          <label for="storageInstructions">Storage Instructions</label>
          <textarea id="storageInstructions" name="storageInstructions" rows="2" placeholder="How to store this product" data-history="product_storage"></textarea>
          
          <label for="expirationInfo">Expiration / Shelf Life</label>
          <input type="text" id="expirationInfo" name="expirationInfo" placeholder="e.g., Best within 30 days" data-history="product_expiration">
          
          <label for="additionalNotes">Additional Notes</label>
          <textarea id="additionalNotes" name="additionalNotes" rows="2" placeholder="Any other relevant information" data-history="product_notes"></textarea>
        </div>

        <label for="image">Primary Image URL</label>
        <input type="text" id="image" name="image" data-history="product_image_url">

        <label for="imageFile">Or upload primary image file</label>
        <input type="file" id="imageFile" name="imageFile" accept="image/*">
        
        <label for="additionalImages">Additional Image URLs (one per line or comma-separated)</label>
        <textarea id="additionalImages" name="additionalImages" rows="3" placeholder="https://example.com/image2.jpg&#10;https://example.com/image3.jpg"></textarea>
        
        <label for="additionalImageFiles">Or upload multiple image files</label>
        <input type="file" id="additionalImageFiles" name="additionalImageFiles" accept="image/*" multiple>
        <div id="imageUploadProgress" style="margin-top:0.5rem;color:#666;"></div>

        <div style="margin-top:1rem;">
          <button type="submit" id="uploadBtn" style="background:#6e33b7;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;">Upload Product</button>
          <button type="button" id="uploadAnotherBtn" style="display:none;margin-left:8px;">Upload another</button>
        </div>
      </form>

      <div id="upload-success" style="display:none;margin-top:1rem;color:green;">Product uploaded successfully!</div>
      <div id="upload-error" style="display:none;margin-top:1rem;color:red;"></div>
    </section>

    <!-- Manage Products -->
    <section style="margin-top:2rem;">
      <h2>Manage Products</h2>
      <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;">
        <button id="loadProductsBtn" style="background:#efefef;padding:0.5rem 0.75rem;border-radius:8px;border:1px solid #ddd;">Load All Products</button>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span style="font-size:0.9rem;color:#666;">View as:</span>
          <button id="viewToggleBtn" data-view="line" style="background:#6e33b7;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;">
            <span id="viewToggleText">Panels</span>
          </button>
        </div>
        <div id="mergeControls" style="display:none;gap:0.5rem;align-items:center;margin-left:auto;flex-wrap:wrap;">
          <span id="selectedCount" style="font-size:0.9rem;color:#666;font-weight:600;">0 selected</span>
          <input type="text" id="groupNameInput" placeholder="Enter group name (e.g., Sauces)" style="padding:0.5rem;border-radius:6px;border:1px solid #ddd;min-width:200px;">
          <button id="mergeProductsBtn" style="background:#10b981;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;font-weight:600;">Merge Selected</button>
          <button id="unmergeProductsBtn" style="background:#f59e0b;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;font-weight:600;">Unmerge Selected</button>
          <button id="cancelMergeBtn" style="background:#ef4444;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;">Cancel</button>
        </div>
        <button id="startMergeBtn" style="background:#6e33b7;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;font-weight:600;margin-left:auto;">Manage Groups</button>
      </div>

      <!-- Filter controls -->
      <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;background:#f8fafc;padding:1rem;border-radius:8px;">
        <div style="display:flex;flex-direction:column;gap:0.25rem;">
          <label for="productTypeFilter" style="font-size:0.85rem;color:#666;font-weight:600;margin:0;">Product Type:</label>
          <select id="productTypeFilter" style="padding:0.5rem;border-radius:6px;border:1px solid #ddd;font-size:0.9rem;">
            <option value="all">All Products</option>
            <option value="decor">Handmade Crafts</option>
            <option value="food">Cottage Food</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.25rem;">
          <label for="subcategoryFilter" style="font-size:0.85rem;color:#666;font-weight:600;margin:0;">Subcategory:</label>
          <select id="subcategoryFilter" style="padding:0.5rem;border-radius:6px;border:1px solid #ddd;font-size:0.9rem;">
            <option value="all">All Subcategories</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:0.25rem;">
          <label for="searchFilter" style="font-size:0.85rem;color:#666;font-weight:600;margin:0;">Search:</label>
          <input type="text" id="searchFilter" placeholder="Search products..." style="padding:0.5rem;border-radius:6px;border:1px solid #ddd;font-size:0.9rem;min-width:200px;">
        </div>
        <button id="clearFiltersBtn" style="background:#ef4444;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;align-self:flex-end;">Clear Filters</button>
        <div id="productCount" style="align-self:flex-end;margin-left:auto;font-size:0.9rem;color:#666;font-weight:600;"></div>
      </div>

      <div id="products-list" style="min-height:120px;"></div>
    </section>


  </main>

  <script>
    // Small utility & config
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:5000'
      : 'https://bonnie-lass-florals.onrender.com';

    // Profile dropdown behavior
    const profileImg = document.getElementById('profileCircle');
    const dropdown = document.getElementById('profileDropdown');
    profileImg && profileImg.addEventListener('click', () => {
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!document.getElementById('profileCircleContainer').contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Initialize UI state based on Firebase auth
    firebase.auth().onAuthStateChanged(async (user) => {
      const userInfo = document.getElementById('userInfoDropdown');
      const adminOrdersLink = document.getElementById('adminOrdersLink');
      const uploadProductLink = document.getElementById('uploadProductLink');
      const paletteLink = document.getElementById('paletteLink');
      const messagesLink = document.getElementById('messagesLink');
      if (!user) {
        userInfo.innerHTML = '<div style="color:#666;">Not signed in</div>';
        adminOrdersLink.style.display = 'none';
        uploadProductLink.style.display = 'none';
        paletteLink.style.display = 'none';
        messagesLink.style.display = 'none';
        return;
      }
      // Force token refresh to get latest custom claims
      const token = await user.getIdToken(true);
      const email = user.email || '';
      userInfo.innerHTML = `<strong style="display:block;">${email}</strong>`;
      
      // Check admin status using backend API
      try {
        const response = await fetch(`${API_BASE}/api/admin/check`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const isAdmin = response.ok ? (await response.json()).isAdmin : false;
        adminOrdersLink.style.display = isAdmin ? 'block' : 'none';
        uploadProductLink.style.display = isAdmin ? 'block' : 'none';
        paletteLink.style.display = isAdmin ? 'block' : 'none';
        messagesLink.style.display = isAdmin ? 'block' : 'none';
      } catch (err) {
        console.error('Error checking admin status:', err);
        adminOrdersLink.style.display = 'none';
        uploadProductLink.style.display = 'none';
        paletteLink.style.display = 'none';
        messagesLink.style.display = 'none';
      }
    });

    // --------------------------
    // Firebase Storage helper
    // --------------------------
    /**
     * Upload image file to Firebase Storage
     * @param {File} file - Image file to upload
     * @returns {Promise<string>} Download URL from Firebase Storage
     */
    async function uploadImageToFirebase(file) {
      // Constants for validation
      const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const MIN_FILENAME_LENGTH = 3;
      const MAX_FILENAME_LENGTH = 100;
      
      // Validate file type
      if (!ALLOWED_TYPES.includes(file.type)) {
        throw new Error('Invalid file type. Only JPEG, PNG, GIF, and WebP images are allowed.');
      }
      
      // Validate file size
      if (file.size > MAX_FILE_SIZE) {
        throw new Error('File size exceeds 10MB limit.');
      }
      
      const storage = firebase.storage();
      const storageRef = storage.ref();
      const timestamp = Date.now();
      
      // Enhanced filename sanitization - remove special chars and path traversal
      let safeName = file.name
        .replace(/[^a-zA-Z0-9._-]/g, '_')  // Replace unsafe chars with underscore
        .replace(/\.{2,}/g, '_')            // Remove path traversal sequences
        .replace(/^\.+/, '')                // Remove leading dots
        .substring(0, MAX_FILENAME_LENGTH); // Limit filename length
      
      // Fallback to default name if sanitization results in empty or very short name
      if (!safeName || safeName.length < MIN_FILENAME_LENGTH) {
        const extension = file.type.split('/')[1] || 'jpg';
        safeName = `image.${extension}`;
      }
      
      const filename = `product-images/${timestamp}-${safeName}`;
      const imageRef = storageRef.child(filename);
      
      // Upload file to Firebase Storage with metadata
      const metadata = {
        contentType: file.type,
        customMetadata: {
          uploadedAt: new Date().toISOString()
        }
      };
      
      const snapshot = await imageRef.put(file, metadata);
      
      // Get the download URL
      const downloadURL = await snapshot.ref.getDownloadURL();
      return downloadURL;
    }

    // --------------------------
    // Single product upload
    // --------------------------
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const user = firebase.auth().currentUser;
      if (!user) { alert('Please login first'); return; }
      const token = await user.getIdToken();

      const form = e.target;
      const uploadBtn = document.getElementById('uploadBtn');
      const progressEl = document.getElementById('imageUploadProgress');
      
      // Hide previous messages
      document.getElementById('upload-success').style.display = 'none';
      document.getElementById('upload-error').style.display = 'none';
      progressEl.textContent = '';
      
      try {
        const imageUrls = [];
        
        // Upload primary image file if provided
        if (form.imageFile.files && form.imageFile.files[0]) {
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Uploading primary image...';
          progressEl.textContent = 'Uploading primary image...';
          
          try {
            const primaryImageUrl = await uploadImageToFirebase(form.imageFile.files[0]);
            imageUrls.push(primaryImageUrl);
          } catch (uploadErr) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Product';
            progressEl.textContent = '';
            throw new Error('Failed to upload primary image: ' + uploadErr.message);
          }
        } else if (form.image.value) {
          // Use primary image URL if provided
          imageUrls.push(form.image.value);
        }
        
        // Add additional image URLs from textarea
        if (form.additionalImages.value) {
          const additionalUrls = form.additionalImages.value
            .split(/[\n,]/)
            .map(url => url.trim())
            .filter(url => url && url.startsWith('http'));
          imageUrls.push(...additionalUrls);
        }
        
        // Upload additional image files if provided
        if (form.additionalImageFiles.files && form.additionalImageFiles.files.length > 0) {
          uploadBtn.disabled = true;
          const totalFiles = form.additionalImageFiles.files.length;
          
          for (let i = 0; i < totalFiles; i++) {
            const file = form.additionalImageFiles.files[i];
            uploadBtn.textContent = `Uploading image ${i + 1}/${totalFiles}...`;
            progressEl.textContent = `Uploading image ${i + 1} of ${totalFiles}...`;
            
            try {
              const imageUrl = await uploadImageToFirebase(file);
              imageUrls.push(imageUrl);
            } catch (uploadErr) {
              console.error(`Failed to upload image ${i + 1}:`, uploadErr);
              progressEl.textContent = `Warning: Failed to upload image ${i + 1}. Continuing...`;
              // Continue with other images
            }
          }
        }
        
        uploadBtn.textContent = 'Saving product...';
        progressEl.textContent = 'Saving product...';
        
        // Send product data as JSON with all image URLs
        const productData = {
          name: form.name.value,
          description: form.description.value,
          price: form.price.value,
          type: form.type.value,
          subcategory: form.subcategory.value || '',
          stock: form.stock.value || 1,
          options: form.options.value || '',
          images: imageUrls, // Send all images
          productGroup: form.productGroup.value.trim() || '',
          extendedDetails: {
            ingredients: form.ingredients.value || '',
            allergens: form.allergens.value || '',
            nutritionalInfo: form.nutritionalInfo.value || '',
            recipe: form.recipe.value || '',
            careInstructions: form.careInstructions.value || '',
            dimensions: form.dimensions.value || '',
            materials: form.materials.value || '',
            weight: form.weight.value || '',
            storageInstructions: form.storageInstructions.value || '',
            expirationInfo: form.expirationInfo.value || '',
            additionalNotes: form.additionalNotes.value || ''
          }
        };

        const res = await fetch(`${API_BASE}/api/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(productData)
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('upload-success').style.display = 'block';
          document.getElementById('upload-error').style.display = 'none';
          progressEl.textContent = '';
          form.reset();
        } else {
          document.getElementById('upload-error').textContent = data.error || 'Upload failed.';
          document.getElementById('upload-error').style.display = 'block';
          progressEl.textContent = '';
        }
      } catch (err) {
        document.getElementById('upload-error').textContent = 'Upload error: ' + err.message;
        document.getElementById('upload-error').style.display = 'block';
      } finally {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Product';
      }
    });

    // --------------------------
    // CSV batch upload
    // --------------------------
    document.getElementById('uploadCsvBtn').addEventListener('click', async function() {
      const fileInput = document.getElementById('csvFile');
      const csvFile = fileInput.files[0];
      const resultEl = document.getElementById('csv-result');

      if (!csvFile) {
        resultEl.innerHTML = '<p style="color:red;">Please select a CSV file.</p>';
        return;
      }
      resultEl.innerHTML = '<p>Processing CSV...</p>';

      try {
        const text = await csvFile.text();
        const parseResult = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').trim().toLowerCase()
        });

        if (parseResult.errors && parseResult.errors.length) {
          console.warn('CSV parse warnings:', parseResult.errors);
        }

        const products = (parseResult.data || []).map(row => {
          // Collect all Etsy image URLs (image1 through image10)
          const images = [];
          for (let i = 1; i <= 10; i++) {
            const imgKey = `image${i}`;
            if (row[imgKey] && row[imgKey].trim()) {
              images.push(row[imgKey].trim());
            }
          }
          
          return {
            name: row.name || row.title || '',
            description: row.description || '',
            price: row.price || row.priceusd || '',
            type: row.type || 'decor',
            subcategory: row.subcategory || '',
            stock: row.stock || row.quantity || '1',
            options: row.options || '',
            image: images.length > 0 ? images[0] : (row.image || ''),
            images: images // Send all images to backend
          };
        }).filter(p => p.name && p.price);

        if (!products.length) {
          resultEl.innerHTML = '<p style="color:red;">No valid products to upload. Check CSV headers (name & price required).</p>';
          return;
        }
        if (products.length > 100) {
          resultEl.innerHTML = '<p style="color:red;">CSV contains more than 100 valid products. Split into smaller batches.</p>';
          return;
        }

        const user = firebase.auth().currentUser;
        if (!user) { resultEl.innerHTML = '<p style="color:red;">Please login first.</p>'; return; }
        const token = await user.getIdToken();

        const res = await fetch(`${API_BASE}/api/products/batch`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ products })
        });

        const raw = await res.text();
        let data;
        try { data = raw ? JSON.parse(raw) : {}; } catch (err) { data = { error: raw }; }

        if (res.ok) {
          let html = `<p style="color:green;">${data.message || 'Batch upload completed.'}</p>`;
          if (data.results && data.results.success && data.results.success.length) {
            html += `<p><strong>Uploaded ${data.results.success.length} products:</strong></p><ul>`;
            data.results.success.forEach(it => { html += `<li>${escapeHtml(it.name || '')} (ID: ${it.id})</li>`; });
            html += '</ul>';
          }
          if (data.results && data.results.errors && data.results.errors.length) {
            html += `<p style="color:red;"><strong>Failed ${data.results.errors.length} products:</strong></p><ul>`;
            data.results.errors.forEach(it => { html += `<li>Row ${it.row}: ${escapeHtml(it.error || 'error')}</li>`; });
            html += '</ul>';
          }
          resultEl.innerHTML = html;
          fileInput.value = '';
        } else {
          resultEl.innerHTML = `<p style="color:red;">Error uploading CSV (status ${res.status}): ${escapeHtml(data.error || raw || 'Unknown error')}</p>`;
          console.error('Batch upload failed:', res.status, data || raw);
        }
      } catch (err) {
        resultEl.innerHTML = `<p style="color:red;">Upload error: ${escapeHtml(err.message)}</p>`;
        console.error('CSV upload error:', err);
      }
    });

    // --------------------------
    // Load / Manage products
    // --------------------------
    let allProducts = [];
    let filteredProducts = [];
    let currentView = 'line'; // 'line' or 'panel'

    document.getElementById('viewToggleBtn').addEventListener('click', function() {
      currentView = currentView === 'line' ? 'panel' : 'line';
      this.dataset.view = currentView;
      document.getElementById('viewToggleText').textContent = currentView === 'line' ? 'Panels' : 'Lines';
      if (allProducts.length > 0) {
        applyProductFilters();
      }
    });

    document.getElementById('loadProductsBtn').addEventListener('click', async function() {
      const list = document.getElementById('products-list');
      list.innerHTML = '<p>Loading products...</p>';
      try {
        // Fetch all products with a high limit to ensure we get everything
        const res = await fetch(`${API_BASE}/api/products?limit=1000`);
        if (!res.ok) throw new Error('Failed to fetch products');
        const payload = await res.json();
        // Normalize response: accept either array (legacy) or object with products array
        const products = Array.isArray(payload) ? payload : (payload.products || []);
        allProducts = products;
        
        // Populate subcategory filter with unique subcategories
        populateSubcategoryFilter();
        
        // Populate product group datalist with unique product groups
        populateProductGroupDatalist();
        
        // Apply initial filters (will show all products)
        applyProductFilters();
      } catch (err) {
        console.error('Error loading products:', err);
        document.getElementById('products-list').innerHTML = '<div style="color:#ef4444;padding:1rem;">Failed to load products. Please try again later.</div>';
      }
    });

    // Populate subcategory filter dropdown with unique values from products
    function populateSubcategoryFilter() {
      const subcategoryFilter = document.getElementById('subcategoryFilter');
      const subcategories = new Set();
      
      allProducts.forEach(p => {
        if (p.subcategory && p.subcategory.trim()) {
          subcategories.add(p.subcategory.trim());
        }
      });
      
      // Clear existing options except "All Subcategories"
      subcategoryFilter.innerHTML = '<option value="all">All Subcategories</option>';
      
      // Add subcategories in alphabetical order
      Array.from(subcategories).sort().forEach(subcat => {
        const option = document.createElement('option');
        option.value = subcat;
        option.textContent = subcat;
        subcategoryFilter.appendChild(option);
      });
    }

    // Populate product group datalist with unique values from products
    function populateProductGroupDatalist() {
      const productGroupList = document.getElementById('productGroupList');
      const productGroups = new Set();
      
      allProducts.forEach(p => {
        if (p.productGroup && p.productGroup.trim()) {
          productGroups.add(p.productGroup.trim());
        }
      });
      
      // Clear existing options
      productGroupList.innerHTML = '';
      
      // Add product groups in alphabetical order
      Array.from(productGroups).sort().forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        productGroupList.appendChild(option);
      });
    }

    // Apply filters to products
    function applyProductFilters() {
      const typeFilter = document.getElementById('productTypeFilter').value;
      const subcategoryFilter = document.getElementById('subcategoryFilter').value;
      const searchFilter = document.getElementById('searchFilter').value.toLowerCase().trim();
      
      // Filter products based on selected criteria
      filteredProducts = allProducts.filter(p => {
        // Type filter
        if (typeFilter !== 'all' && p.type !== typeFilter) {
          return false;
        }
        
        // Subcategory filter
        if (subcategoryFilter !== 'all' && p.subcategory !== subcategoryFilter) {
          return false;
        }
        
        // Search filter (search in name, description, subcategory)
        if (searchFilter) {
          const searchText = [
            p.name || '',
            p.description || '',
            p.subcategory || '',
            p.productGroup || ''
          ].join(' ').toLowerCase();
          
          if (!searchText.includes(searchFilter)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Update product count display
      const productCount = document.getElementById('productCount');
      productCount.textContent = `Showing ${filteredProducts.length} of ${allProducts.length} products`;
      
      // Render filtered products
      if (currentView === 'line') renderLineView(filteredProducts);
      else renderPanelView(filteredProducts);
    }

    // Event listeners for filters
    document.getElementById('productTypeFilter').addEventListener('change', applyProductFilters);
    document.getElementById('subcategoryFilter').addEventListener('change', applyProductFilters);
    document.getElementById('searchFilter').addEventListener('input', applyProductFilters);
    
    // Clear filters button
    document.getElementById('clearFiltersBtn').addEventListener('click', function() {
      document.getElementById('productTypeFilter').value = 'all';
      document.getElementById('subcategoryFilter').value = 'all';
      document.getElementById('searchFilter').value = '';
      applyProductFilters();
    });

    function renderLineView(products) {
      let html = `<table style="width:100%;border-collapse:collapse">`;
      html += `<thead><tr>`;
      if (mergeMode) {
        html += `<th style="text-align:center;padding:0.5rem;border-bottom:1px solid #eee;width:50px;">Select</th>`;
      }
      html += `<th style="text-align:left;padding:0.5rem;border-bottom:1px solid #eee;">Name</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Price</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Stock</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Type</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Group</th>`;
      if (!mergeMode) {
        html += `<th style="padding:0.5rem;border-bottom:1px solid #eee;">Actions</th>`;
      }
      html += `</tr></thead>`;
      html += `<tbody>`;
      products.forEach(p => {
        html += `<tr>`;
        if (mergeMode) {
          const isChecked = selectedProducts.has(p._id);
          html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;text-align:center;">`;
          html += `<input type="checkbox" data-product-id="${p._id}" class="product-checkbox" ${isChecked ? 'checked' : ''} style="width:18px;height:18px;cursor:pointer;">`;
          html += `</td>`;
        }
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(p.name || '')}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">$${(p.price || 0).toFixed ? (Number(p.price).toFixed(2)) : escapeHtml(String(p.price || ''))}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(String(p.stock || 0))}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(p.type || '')}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">`;
        if (p.productGroup && p.productGroup.trim()) {
          html += `<span style="background:#6e33b7;color:#fff;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.8rem;font-weight:600;white-space:nowrap;">ðŸ“¦ ${escapeHtml(p.productGroup)}</span>`;
        } else {
          html += `<span style="color:#999;font-size:0.85rem;">â€”</span>`;
        }
        html += `</td>`;
        if (!mergeMode) {
          html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">`;
          html += `<button data-id="${p._id}" class="edit-btn" style="margin-right:0.5rem;">Edit</button>`;
          html += `<button data-id="${p._id}" class="delete-btn" style="background:#f87171;color:#fff;border:none;padding:0.4rem 0.6rem;border-radius:4px;">Delete</button>`;
          html += `</td>`;
        }
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('products-list').innerHTML = html;
      
      // Add event listeners for checkboxes
      if (mergeMode) {
        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            handleCheckboxChange(this.dataset.productId, this.checked);
          });
        });
      }
    }

    function renderPanelView(products) {
      let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.25rem;">';
      products.forEach(p => {
        const imageUrl = (p.images && p.images.length > 0) ? p.images[0] : (p.image || '/img/default-product.png');
        const imageCount = (p.images && p.images.length) || 0;
        const isChecked = selectedProducts.has(p._id);
        html += `<div style="border:1px solid ${isChecked && mergeMode ? '#10b981' : '#ddd'};border-radius:8px;padding:1rem;background:#fff;${isChecked && mergeMode ? 'box-shadow:0 0 0 2px rgba(16,185,129,0.2);' : ''}">`;
        html += `<div style="position:relative;">`;
        html += `<img src="${escapeAttr(imageUrl)}" alt="${escapeAttr(p.name||'')}" style="width:100%;height:200px;object-fit:cover;border-radius:4px;margin-bottom:0.75rem;" onerror="this.src='/img/default-product.png'">`;
        if (imageCount > 1) {
          html += `<div style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.7);color:#fff;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.85rem;font-weight:600;">${imageCount} images</div>`;
        }
        if (mergeMode) {
          html += `<div style="position:absolute;top:8px;left:8px;background:#fff;border-radius:4px;padding:0.25rem;">`;
          html += `<input type="checkbox" data-product-id="${p._id}" class="product-checkbox" ${isChecked ? 'checked' : ''} style="width:20px;height:20px;cursor:pointer;">`;
          html += `</div>`;
        }
        html += `</div>`;
        html += `<div style="font-weight:700;margin-bottom:0.25rem;">${escapeHtml(p.name || '')}</div>`;
        html += `<div style="color:#666;margin-bottom:0.5rem;">$${(p.price || 0).toFixed ? Number(p.price).toFixed(2) : escapeHtml(String(p.price||''))}</div>`;
        if (p.productGroup && p.productGroup.trim()) {
          html += `<div style="margin-bottom:0.5rem;">`;
          html += `<span style="background:#6e33b7;color:#fff;padding:0.25rem 0.5rem;border-radius:4px;font-size:0.8rem;font-weight:600;display:inline-block;">ðŸ“¦ ${escapeHtml(p.productGroup)}</span>`;
          html += `</div>`;
        }
        if (!mergeMode) {
          html += `<div style="display:flex;gap:0.5rem;">`;
          html += `<button data-id="${p._id}" class="edit-btn" style="flex:1;padding:0.5rem;background:#efefef;border-radius:4px;border:1px solid #ddd;">Edit</button>`;
          html += `<button data-id="${p._id}" class="delete-btn" style="flex:1;padding:0.5rem;background:#f87171;color:#fff;border:none;border-radius:4px;">Delete</button>`;
          html += `</div>`;
        }
        html += `</div>`;
      });
      html += '</div>';
      document.getElementById('products-list').innerHTML = html;
      
      // Add event listeners for checkboxes
      if (mergeMode) {
        document.querySelectorAll('.product-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            handleCheckboxChange(this.dataset.productId, this.checked);
          });
        });
      }
    }

    // Event delegation for edit/delete buttons
    document.getElementById('products-list').addEventListener('click', async function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const id = e.target.dataset.id;
        // Navigate to dedicated edit page
        window.location.href = `/admin/edit-product.html?id=${id}`;
      } else if (e.target.classList.contains('delete-btn')) {
        const id = e.target.dataset.id;
        if (!confirm('Delete product? This action cannot be undone.')) return;
        try {
          const user = firebase.auth().currentUser;
          if (!user) { alert('Please login first'); return; }
          const token = await user.getIdToken();
          const res = await fetch(`${API_BASE}/api/products/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.ok) {
            alert('Deleted.');
            document.getElementById('loadProductsBtn').click();
          } else {
            const text = await res.text();
            alert('Delete failed: ' + text);
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
    });

    // --------------------------
    // Merge Products Functionality
    // --------------------------
    let selectedProducts = new Set();
    let mergeMode = false;

    // Toggle merge mode
    document.getElementById('startMergeBtn').addEventListener('click', function() {
      mergeMode = true;
      selectedProducts.clear();
      document.getElementById('startMergeBtn').style.display = 'none';
      document.getElementById('mergeControls').style.display = 'flex';
      updateSelectedCount();
      // Re-render products list with checkboxes
      if (filteredProducts.length > 0) {
        if (currentView === 'line') renderLineView(filteredProducts);
        else renderPanelView(filteredProducts);
      }
    });

    // Cancel merge mode
    document.getElementById('cancelMergeBtn').addEventListener('click', function() {
      mergeMode = false;
      selectedProducts.clear();
      document.getElementById('startMergeBtn').style.display = 'block';
      document.getElementById('mergeControls').style.display = 'none';
      document.getElementById('groupNameInput').value = '';
      // Re-render products list without checkboxes
      if (filteredProducts.length > 0) {
        if (currentView === 'line') renderLineView(filteredProducts);
        else renderPanelView(filteredProducts);
      }
    });

    // Update selected count display
    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = `${selectedProducts.size} selected`;
    }

    // Handle checkbox changes
    function handleCheckboxChange(productId, isChecked) {
      if (isChecked) {
        selectedProducts.add(productId);
      } else {
        selectedProducts.delete(productId);
      }
      updateSelectedCount();
    }

    // Merge selected products
    document.getElementById('mergeProductsBtn').addEventListener('click', async function() {
      const groupName = document.getElementById('groupNameInput').value.trim();
      
      if (!groupName) {
        alert('Please enter a group name');
        return;
      }

      if (selectedProducts.size === 0) {
        alert('Please select at least one product to merge');
        return;
      }

      if (!confirm(`Merge ${selectedProducts.size} products into group "${groupName}"?`)) {
        return;
      }

      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please login first');
          return;
        }
        const token = await user.getIdToken();

        const res = await fetch(`${API_BASE}/api/products/batch`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            productIds: Array.from(selectedProducts),
            productGroup: groupName
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert(`Successfully merged ${data.modifiedCount} products into group "${groupName}"`);
          // Reset merge mode
          mergeMode = false;
          selectedProducts.clear();
          document.getElementById('startMergeBtn').style.display = 'block';
          document.getElementById('mergeControls').style.display = 'none';
          document.getElementById('groupNameInput').value = '';
          // Reload products
          document.getElementById('loadProductsBtn').click();
        } else {
          alert('Merge failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
        console.error('Merge error:', err);
      }
    });

    // Unmerge selected products
    document.getElementById('unmergeProductsBtn').addEventListener('click', async function() {
      if (selectedProducts.size === 0) {
        alert('Please select at least one product to unmerge');
        return;
      }

      if (!confirm(`Unmerge ${selectedProducts.size} products from their groups?`)) {
        return;
      }

      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          alert('Please login first');
          return;
        }
        const token = await user.getIdToken();

        const res = await fetch(`${API_BASE}/api/products/batch/unmerge`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            productIds: Array.from(selectedProducts)
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert(`Successfully unmerged ${data.modifiedCount} products from their groups`);
          // Reset merge mode
          mergeMode = false;
          selectedProducts.clear();
          document.getElementById('startMergeBtn').style.display = 'block';
          document.getElementById('mergeControls').style.display = 'none';
          document.getElementById('groupNameInput').value = '';
          // Reload products
          document.getElementById('loadProductsBtn').click();
        } else {
          alert('Unmerge failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
        console.error('Unmerge error:', err);
      }
    });

    // --------------------------
    // Helpers
    // --------------------------
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
    }
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, '&quot;');
    }

    // Load products on page load (non-admin will be redirected by admin-guard)
    document.addEventListener('DOMContentLoaded', function() {
      // Keep initial products hidden until user clicks load (safer for admin-only)
      // Optionally auto-load:
      // document.getElementById('loadProductsBtn').click();
    });
  </script>

  <script src="/ui-utils.js"></script>
  <script src="/mobile-nav.js"></script>
  <script src="/ui-utils.js"></script>
  <script src="/auth.js"></script>
</body>
</html>
