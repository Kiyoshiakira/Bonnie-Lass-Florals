<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin — Upload Product | Bonnie Lass Florals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Root-absolute asset paths so this works from /admin/ and root -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/auth.css">
  <!-- Ensure relative links resolve from site root (helps copied header work) -->
  <base href="/" />
  <!-- Theme Loader - Load early to minimize FOUC -->
  <script src="/theme-loader.js"></script>
  <!-- Admin Guard - Must be loaded before Firebase to prevent unauthorized access -->
  <script src="/admin-guard.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    // Firebase client config
    // NOTE: API key is public by design - security is enforced by Firebase Storage Rules
    // which require authentication and validate file types/sizes server-side
    const firebaseConfig = {
      apiKey: "AIzaSyBo4GNnJd8awnviuIlo9mJ9vaar8jvf6G0",
      authDomain: "bonnie-lass-florals.firebaseapp.com",
      projectId: "bonnie-lass-florals",
      storageBucket: "bonnie-lass-florals.firebasestorage.app",
      messagingSenderId: "1009091302977",
      appId: "1:1009091302977:web:2322ff602eccee4509d8c0",
      measurementId: "G-DQRB98D0WY"
    };
    firebase.initializeApp(firebaseConfig);
  </script>

  <style>
    /* Small admin page tweaks for layout */
    main { max-width: 1000px; margin: 2rem auto; padding: 1rem; }
    header { display:flex; align-items:center; gap:1rem; padding:1rem; border-bottom:1px solid #eee; }
    header .logo { display:flex; align-items:center; gap:12px; font-weight:bold; color:#4b2f6f; }
    header nav { display:flex; gap:1rem; margin-left:1rem; }
    #profileCircleContainer { margin-left:auto; position:relative; }
    #profileDropdown { display:none; position:absolute; right:0; top:48px; background:#fff; border:1px solid #ddd; border-radius:6px; min-width:180px; box-shadow:0 6px 18px rgba(0,0,0,0.08); z-index:50; }
    #profileDropdown a { display:block; padding:0.5rem 0.75rem; color:#333; text-decoration:none; }
    #profileDropdown a:hover { background:#f6f6f6; }
    .admin-section { background:#f8fafc; padding:1.25rem; border-radius:8px; margin-bottom:1.25rem; }
    label { display:block; margin-top:0.75rem; font-weight:600; }
    input[type="text"], input[type="number"], textarea, select { width:100%; padding:0.5rem; margin-top:0.25rem; border-radius:6px; border:1px solid #ddd; }
    button { cursor:pointer; }
    .product-card img { max-width:100%; display:block; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:90; }
    .modal .panel { background:#fff; padding:1rem; border-radius:8px; width:90%; max-width:720px; max-height:90vh; overflow:auto; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/img/logo.png" alt="Bonnie Lass Florals Logo" style="height:48px;vertical-align:middle;">
      Bonnie Lass Florals
    </div>

    <nav>
      <a href="/index.html">Home</a>
      <a href="/about.html">About</a>
      <a href="/shop.html">Shop</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/contact.html">Contact</a>
    </nav>

    <!-- Profile circle + dropdown -->
    <div id="profileCircleContainer">
      <img id="profileCircle" src="/img/default-avatar.png" alt="Profile" style="height:40px;width:40px;border-radius:50%;cursor:pointer;" />
      <div id="profileDropdown">
        <div id="userInfoDropdown" style="padding:0.75rem;border-bottom:1px solid #f0f0f0;"></div>
        <a href="/profile.html">Profile</a>
        <a href="/orders.html">Orders</a>
        <a id="adminOrdersLink" href="/admin/orders.html" style="display:none;">All Orders (Admin)</a>
        <a id="uploadProductLink" href="/admin/upload.html" style="display:none;">Upload Product</a>
      </div>
    </div>
  </header>

  <main>
    <div style="font-size:0.95rem;color:#666;margin-bottom:0.75rem;">
      <a href="/index.html">Home</a> <span style="color:#bbb;margin:0 8px;">›</span>
      <a href="/profile.html">Profile</a> <span style="color:#bbb;margin:0 8px;">›</span>
      <span style="font-weight:600;">Upload Product</span>
    </div>

    <h1>Upload New Product</h1>

    <!-- CSV Batch Upload Section -->
    <section class="admin-section" aria-labelledby="csv-title">
      <h2 id="csv-title" style="margin-top:0;">Batch Upload via CSV</h2>
      <p style="margin:0 0 0.5rem 0;">Upload multiple products at once using a CSV. Columns: name, description, price, type, subcategory, stock, options, image</p>
      <input type="file" id="csvFile" accept=".csv" style="margin-bottom:0.75rem;">
      <div>
        <button id="uploadCsvBtn" style="background:#10b981;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;">Upload CSV</button>
      </div>
      <div id="csv-result" style="margin-top:1rem;"></div>
    </section>

    <!-- Single Product Upload Form -->
    <section>
      <h2>Single Product Upload</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="name">Product Name</label>
        <input type="text" id="name" name="name" required>

        <label for="description">Description</label>
        <textarea id="description" name="description" required rows="4"></textarea>

        <label for="price">Price</label>
        <input type="number" id="price" name="price" step="0.01" required>

        <label for="type">Type</label>
        <select id="type" name="type" required>
          <option value="decor">Handmade Crafts</option>
          <option value="food">Cottage Food</option>
        </select>

        <label for="subcategory">Subcategory</label>
        <input type="text" id="subcategory" name="subcategory">

        <label for="stock">Stock</label>
        <input type="number" id="stock" name="stock" min="0" value="1" required>

        <label for="options">Options (comma-separated)</label>
        <input type="text" id="options" name="options">

        <label for="image">Image URL</label>
        <input type="text" id="image" name="image">

        <label for="imageFile">Or upload image file</label>
        <input type="file" id="imageFile" name="imageFile" accept="image/*">

        <div style="margin-top:1rem;">
          <button type="submit" id="uploadBtn" style="background:#6e33b7;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;">Upload Product</button>
          <button type="button" id="uploadAnotherBtn" style="display:none;margin-left:8px;">Upload another</button>
        </div>
      </form>

      <div id="upload-success" style="display:none;margin-top:1rem;color:green;">Product uploaded successfully!</div>
      <div id="upload-error" style="display:none;margin-top:1rem;color:red;"></div>
    </section>

    <!-- Manage Products -->
    <section style="margin-top:2rem;">
      <h2>Manage Products</h2>
      <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1rem;">
        <button id="loadProductsBtn" style="background:#efefef;padding:0.5rem 0.75rem;border-radius:8px;border:1px solid #ddd;">Load All Products</button>
        <div style="display:flex;gap:0.5rem;align-items:center;">
          <span style="font-size:0.9rem;color:#666;">View as:</span>
          <button id="viewToggleBtn" data-view="line" style="background:#6e33b7;color:#fff;padding:0.5rem 0.75rem;border-radius:8px;border:none;">
            <span id="viewToggleText">Panels</span>
          </button>
        </div>
      </div>

      <div id="products-list" style="min-height:120px;"></div>
    </section>

    <!-- Edit modal -->
    <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="panel">
        <h3>Edit Product</h3>
        <form id="editForm">
          <input type="hidden" id="editProductId">
          <label for="editName">Name</label>
          <input id="editName" name="name" type="text" required>
          <label for="editDescription">Description</label>
          <textarea id="editDescription" name="description" rows="3"></textarea>
          <label for="editPrice">Price</label>
          <input id="editPrice" name="price" type="number" step="0.01">
          <label for="editType">Type</label>
          <select id="editType" name="type">
            <option value="decor">Handmade Crafts</option>
            <option value="food">Cottage Food</option>
          </select>
          <label for="editStock">Stock</label>
          <input id="editStock" name="stock" type="number" min="0">
          <label for="editOptions">Options</label>
          <input id="editOptions" name="options" type="text">
          <label>Current Image</label>
          <div id="currentImagePreview" style="margin-bottom:1rem;"></div>
          <label for="editImage">Image URL</label>
          <input id="editImage" name="image" type="text">
          <label for="editImageFile">Or upload new image file</label>
          <input id="editImageFile" name="imageFile" type="file" accept="image/*">

          <div style="margin-top:1rem;display:flex;gap:0.5rem;">
            <button type="submit" style="background:#6e33b7;color:#fff;padding:0.6rem 1rem;border-radius:8px;border:none;">Save Changes</button>
            <button type="button" id="cancelEditBtn" style="background:#ccc;color:#333;padding:0.6rem 1rem;border-radius:8px;border:none;">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script>
    // Small utility & config
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:5000'
      : 'https://bonnie-lass-florals.onrender.com';

    // Profile dropdown behavior
    const profileImg = document.getElementById('profileCircle');
    const dropdown = document.getElementById('profileDropdown');
    profileImg && profileImg.addEventListener('click', () => {
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', (e) => {
      if (!document.getElementById('profileCircleContainer').contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Initialize UI state based on Firebase auth
    firebase.auth().onAuthStateChanged(async (user) => {
      const userInfo = document.getElementById('userInfoDropdown');
      const adminOrdersLink = document.getElementById('adminOrdersLink');
      const uploadProductLink = document.getElementById('uploadProductLink');
      if (!user) {
        userInfo.innerHTML = '<div style="color:#666;">Not signed in</div>';
        adminOrdersLink.style.display = 'none';
        uploadProductLink.style.display = 'none';
        return;
      }
      const token = await user.getIdToken();
      const email = user.email || '';
      userInfo.innerHTML = `<strong style="display:block;">${email}</strong>`;
      
      // Check admin status using backend API
      try {
        const response = await fetch(`${API_BASE}/api/admin/check`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const isAdmin = response.ok ? (await response.json()).isAdmin : false;
        adminOrdersLink.style.display = isAdmin ? 'block' : 'none';
        uploadProductLink.style.display = isAdmin ? 'block' : 'none';
      } catch (err) {
        console.error('Error checking admin status:', err);
        adminOrdersLink.style.display = 'none';
        uploadProductLink.style.display = 'none';
      }
    });

    // --------------------------
    // Firebase Storage helper
    // --------------------------
    /**
     * Upload image file to Firebase Storage
     * @param {File} file - Image file to upload
     * @returns {Promise<string>} Download URL from Firebase Storage
     */
    async function uploadImageToFirebase(file) {
      // Validate file type
      const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
      if (!allowedTypes.includes(file.type)) {
        throw new Error('Invalid file type. Only JPEG, PNG, GIF, and WebP images are allowed.');
      }
      
      // Validate file size (max 10MB)
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        throw new Error('File size exceeds 10MB limit.');
      }
      
      const storage = firebase.storage();
      const storageRef = storage.ref();
      const timestamp = Date.now();
      
      // Enhanced filename sanitization - remove special chars and path traversal
      const safeName = file.name
        .replace(/[^a-zA-Z0-9._-]/g, '_')  // Replace unsafe chars with underscore
        .replace(/\.{2,}/g, '_')            // Remove path traversal sequences
        .replace(/^\.+/, '')                // Remove leading dots
        .substring(0, 100);                 // Limit filename length
      
      const filename = `product-images/${timestamp}-${safeName}`;
      const imageRef = storageRef.child(filename);
      
      // Upload file to Firebase Storage with metadata
      const metadata = {
        contentType: file.type,
        customMetadata: {
          uploadedAt: new Date().toISOString()
        }
      };
      
      const snapshot = await imageRef.put(file, metadata);
      
      // Get the download URL
      const downloadURL = await snapshot.ref.getDownloadURL();
      return downloadURL;
    }

    // --------------------------
    // Single product upload
    // --------------------------
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const user = firebase.auth().currentUser;
      if (!user) { alert('Please login first'); return; }
      const token = await user.getIdToken();

      const form = e.target;
      
      // Hide previous messages
      document.getElementById('upload-success').style.display = 'none';
      document.getElementById('upload-error').style.display = 'none';
      
      try {
        let imageUrl = form.image.value || '';
        
        // If a file was selected, upload it to Firebase Storage first
        if (form.imageFile.files && form.imageFile.files[0]) {
          const uploadBtn = document.getElementById('uploadBtn');
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Uploading image...';
          
          try {
            imageUrl = await uploadImageToFirebase(form.imageFile.files[0]);
          } catch (uploadErr) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload Product';
            throw new Error('Failed to upload image to storage: ' + uploadErr.message);
          }
          
          uploadBtn.textContent = 'Saving product...';
        }
        
        // Send product data as JSON with image URL
        const productData = {
          name: form.name.value,
          description: form.description.value,
          price: form.price.value,
          type: form.type.value,
          subcategory: form.subcategory.value || '',
          stock: form.stock.value || 1,
          options: form.options.value || '',
          image: imageUrl
        };

        const res = await fetch(`${API_BASE}/api/products`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(productData)
        });

        const data = await res.json();
        if (res.ok) {
          document.getElementById('upload-success').style.display = 'block';
          document.getElementById('upload-error').style.display = 'none';
          form.reset();
        } else {
          document.getElementById('upload-error').textContent = data.error || 'Upload failed.';
          document.getElementById('upload-error').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('upload-error').textContent = 'Upload error: ' + err.message;
        document.getElementById('upload-error').style.display = 'block';
      } finally {
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Upload Product';
      }
    });

    // --------------------------
    // CSV batch upload
    // --------------------------
    document.getElementById('uploadCsvBtn').addEventListener('click', async function() {
      const fileInput = document.getElementById('csvFile');
      const csvFile = fileInput.files[0];
      const resultEl = document.getElementById('csv-result');

      if (!csvFile) {
        resultEl.innerHTML = '<p style="color:red;">Please select a CSV file.</p>';
        return;
      }
      resultEl.innerHTML = '<p>Processing CSV...</p>';

      try {
        const text = await csvFile.text();
        const parseResult = Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          transformHeader: h => (h || '').trim().toLowerCase()
        });

        if (parseResult.errors && parseResult.errors.length) {
          console.warn('CSV parse warnings:', parseResult.errors);
        }

        const products = (parseResult.data || []).map(row => ({
          name: row.name || row.title || '',
          description: row.description || '',
          price: row.price || row.priceusd || '',
          type: row.type || 'decor',
          subcategory: row.subcategory || '',
          stock: row.stock || row.quantity || '1',
          options: row.options || '',
          image: row.image || row.image1 || ''
        })).filter(p => p.name && p.price);

        if (!products.length) {
          resultEl.innerHTML = '<p style="color:red;">No valid products to upload. Check CSV headers (name & price required).</p>';
          return;
        }
        if (products.length > 100) {
          resultEl.innerHTML = '<p style="color:red;">CSV contains more than 100 valid products. Split into smaller batches.</p>';
          return;
        }

        const user = firebase.auth().currentUser;
        if (!user) { resultEl.innerHTML = '<p style="color:red;">Please login first.</p>'; return; }
        const token = await user.getIdToken();

        const res = await fetch(`${API_BASE}/api/products/batch`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ products })
        });

        const raw = await res.text();
        let data;
        try { data = raw ? JSON.parse(raw) : {}; } catch (err) { data = { error: raw }; }

        if (res.ok) {
          let html = `<p style="color:green;">${data.message || 'Batch upload completed.'}</p>`;
          if (data.results && data.results.success && data.results.success.length) {
            html += `<p><strong>Uploaded ${data.results.success.length} products:</strong></p><ul>`;
            data.results.success.forEach(it => { html += `<li>${escapeHtml(it.name || '')} (ID: ${it.id})</li>`; });
            html += '</ul>';
          }
          if (data.results && data.results.errors && data.results.errors.length) {
            html += `<p style="color:red;"><strong>Failed ${data.results.errors.length} products:</strong></p><ul>`;
            data.results.errors.forEach(it => { html += `<li>Row ${it.row}: ${escapeHtml(it.error || 'error')}</li>`; });
            html += '</ul>';
          }
          resultEl.innerHTML = html;
          fileInput.value = '';
        } else {
          resultEl.innerHTML = `<p style="color:red;">Error uploading CSV (status ${res.status}): ${escapeHtml(data.error || raw || 'Unknown error')}</p>`;
          console.error('Batch upload failed:', res.status, data || raw);
        }
      } catch (err) {
        resultEl.innerHTML = `<p style="color:red;">Upload error: ${escapeHtml(err.message)}</p>`;
        console.error('CSV upload error:', err);
      }
    });

    // --------------------------
    // Load / Manage products
    // --------------------------
    let allProducts = [];
    let currentView = 'line'; // 'line' or 'panel'

    document.getElementById('viewToggleBtn').addEventListener('click', function() {
      currentView = currentView === 'line' ? 'panel' : 'line';
      this.dataset.view = currentView;
      document.getElementById('viewToggleText').textContent = currentView === 'line' ? 'Panels' : 'Lines';
      if (document.getElementById('products-list').innerHTML !== '') {
        document.getElementById('loadProductsBtn').click();
      }
    });

    document.getElementById('loadProductsBtn').addEventListener('click', async function() {
      const list = document.getElementById('products-list');
      list.innerHTML = '<p>Loading products...</p>';
      try {
        const res = await fetch(`${API_BASE}/api/products`);
        if (!res.ok) throw new Error('Failed to fetch products');
        const products = await res.json();
        allProducts = products || [];
        if (currentView === 'line') renderLineView(allProducts);
        else renderPanelView(allProducts);
      } catch (err) {
        console.error('Error loading products:', err);
        document.getElementById('products-list').innerHTML = '<div style="color:#ef4444;padding:1rem;">Failed to load products. Please try again later.</div>';
      }
    });

    function renderLineView(products) {
      let html = `<table style="width:100%;border-collapse:collapse">`;
      html += `<thead><tr><th style="text-align:left;padding:0.5rem;border-bottom:1px solid #eee;">Name</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Price</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Stock</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Type</th><th style="padding:0.5rem;border-bottom:1px solid #eee;">Actions</th></tr></thead>`;
      html += `<tbody>`;
      products.forEach(p => {
        html += `<tr>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(p.name || '')}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">$${(p.price || 0).toFixed ? (Number(p.price).toFixed(2)) : escapeHtml(String(p.price || ''))}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(String(p.stock || 0))}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">${escapeHtml(p.type || '')}</td>`;
        html += `<td style="padding:0.5rem;border-bottom:1px solid #f5f5f5;">`;
        html += `<button data-id="${p._id}" class="edit-btn" style="margin-right:0.5rem;">Edit</button>`;
        html += `<button data-id="${p._id}" class="delete-btn" style="background:#f87171;color:#fff;border:none;padding:0.4rem 0.6rem;border-radius:4px;">Delete</button>`;
        html += `</td>`;
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('products-list').innerHTML = html;
    }

    function renderPanelView(products) {
      let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.25rem;">';
      products.forEach(p => {
        const imageUrl = p.image || '/img/default-product.png';
        html += `<div style="border:1px solid #ddd;border-radius:8px;padding:1rem;background:#fff;">`;
        html += `<img src="${escapeAttr(imageUrl)}" alt="${escapeAttr(p.name||'')}" style="width:100%;height:200px;object-fit:cover;border-radius:4px;margin-bottom:0.75rem;" onerror="this.src='/img/default-product.png'">`;
        html += `<div style="font-weight:700;margin-bottom:0.25rem;">${escapeHtml(p.name || '')}</div>`;
        html += `<div style="color:#666;margin-bottom:0.5rem;">$${(p.price || 0).toFixed ? Number(p.price).toFixed(2) : escapeHtml(String(p.price||''))}</div>`;
        html += `<div style="display:flex;gap:0.5rem;">`;
        html += `<button data-id="${p._id}" class="edit-btn" style="flex:1;padding:0.5rem;background:#efefef;border-radius:4px;border:1px solid #ddd;">Edit</button>`;
        html += `<button data-id="${p._id}" class="delete-btn" style="flex:1;padding:0.5rem;background:#f87171;color:#fff;border:none;border-radius:4px;">Delete</button>`;
        html += `</div></div>`;
      });
      html += '</div>';
      document.getElementById('products-list').innerHTML = html;
    }

    // Event delegation for edit/delete buttons
    document.getElementById('products-list').addEventListener('click', async function(e) {
      if (e.target.classList.contains('edit-btn')) {
        const id = e.target.dataset.id;
        openEditModal(id);
      } else if (e.target.classList.contains('delete-btn')) {
        const id = e.target.dataset.id;
        if (!confirm('Delete product? This action cannot be undone.')) return;
        try {
          const user = firebase.auth().currentUser;
          if (!user) { alert('Please login first'); return; }
          const token = await user.getIdToken();
          const res = await fetch(`${API_BASE}/api/products/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': 'Bearer ' + token }
          });
          if (res.ok) {
            alert('Deleted.');
            document.getElementById('loadProductsBtn').click();
          } else {
            const text = await res.text();
            alert('Delete failed: ' + text);
          }
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
    });

    // --------------------------
    // Edit modal handlers
    // --------------------------
    function openEditModal(id) {
      const product = allProducts.find(p => p._id === id);
      if (!product) { alert('Product not found'); return; }
      document.getElementById('editProductId').value = product._id;
      document.getElementById('editName').value = product.name || '';
      document.getElementById('editDescription').value = product.description || '';
      document.getElementById('editPrice').value = product.price || '';
      document.getElementById('editType').value = product.type || 'decor';
      document.getElementById('editStock').value = product.stock || 1;
      document.getElementById('editOptions').value = (product.options && product.options.join) ? product.options.join(',') : (product.options || '');
      document.getElementById('editImage').value = product.image || '';
      document.getElementById('currentImagePreview').innerHTML = product.image ? `<img src="${escapeAttr(product.image)}" style="max-width:200px;">` : '<div style="color:#999;">No image</div>';
      document.getElementById('editModal').style.display = 'flex';
      document.getElementById('editModal').setAttribute('aria-hidden', 'false');
    }

    document.getElementById('cancelEditBtn').addEventListener('click', function() {
      closeEditModal();
    });

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('editModal').setAttribute('aria-hidden', 'true');
    }

    // Submit edit
    document.getElementById('editForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const id = document.getElementById('editProductId').value;
      const body = {
        name: document.getElementById('editName').value,
        description: document.getElementById('editDescription').value,
        price: document.getElementById('editPrice').value,
        type: document.getElementById('editType').value,
        stock: document.getElementById('editStock').value,
        options: document.getElementById('editOptions').value
      };

      try {
        const user = firebase.auth().currentUser;
        if (!user) { alert('Please login first'); return; }
        const token = await user.getIdToken();

        // If a file was provided, upload to Firebase Storage first
        const fileInput = document.getElementById('editImageFile');
        if (fileInput.files && fileInput.files[0]) {
          const submitBtn = e.target.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.textContent = 'Uploading image...';
          
          try {
            const imageUrl = await uploadImageToFirebase(fileInput.files[0]);
            body.image = imageUrl;
          } catch (uploadErr) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Save Changes';
            throw new Error('Failed to upload image to storage: ' + uploadErr.message);
          }
          
          submitBtn.textContent = 'Saving changes...';
        } else if (document.getElementById('editImage').value) {
          // Use the URL provided in the text field
          body.image = document.getElementById('editImage').value;
        }

        // Send as JSON with image URL
        const res = await fetch(`${API_BASE}/api/products/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if (res.ok) {
          closeEditModal();
          document.getElementById('loadProductsBtn').click();
        } else {
          alert('Update failed: ' + (data.error || JSON.stringify(data)));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      } finally {
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Save Changes';
        }
      }
    });

    // --------------------------
    // Helpers
    // --------------------------
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]);
    }
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, '&quot;');
    }

    // Load products on page load (non-admin will be redirected by admin-guard)
    document.addEventListener('DOMContentLoaded', function() {
      // Keep initial products hidden until user clicks load (safer for admin-only)
      // Optionally auto-load:
      // document.getElementById('loadProductsBtn').click();
    });
  </script>

  <script src="/mobile-nav.js"></script>
  <script src="/auth.js"></script>
</body>
</html>
