<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Edit Product | Bonnie Lass Florals</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico">
  <!-- Preconnect to external domains for faster resource loading -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://bonnie-lass-florals.onrender.com" crossorigin>
  <!-- Preload critical CSS -->
  <link rel="preload" href="/styles.css" as="style">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/auth.css">
  <base href="/" />
  <!-- Theme Loader - Load early to minimize FOUC -->
  <script src="/theme-loader.js"></script>
  <!-- Admin Guard - Must be loaded before Firebase to prevent unauthorized access -->
  <script src="/admin-guard.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>

  <script src="/firebase-config.js"></script>
  <script>
    initFirebase();
  </script>
  <!-- Input History Feature -->
  <script src="/input-history.js"></script>

  <style>
    /* Admin page layout */
    main { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
    header { display:flex; align-items:center; gap:1rem; padding:1rem; border-bottom:1px solid #eee; }
    header .logo { display:flex; align-items:center; gap:12px; font-weight:bold; color:#4b2f6f; }
    header nav { display:flex; gap:1rem; margin-left:1rem; }
    #profileCircleContainer { margin-left:auto; position:relative; }
    #profileDropdown { display:none; position:absolute; right:0; top:48px; background:#fff; border:1px solid #ddd; border-radius:6px; min-width:180px; box-shadow:0 6px 18px rgba(0,0,0,0.08); z-index:50; }
    #profileDropdown a, #profileDropdown button { display:block; width:100%; padding:0.5rem 0.75rem; color:#333; text-decoration:none; background:none; border:none; text-align:left; cursor:pointer; }
    #profileDropdown a:hover, #profileDropdown button:hover { background:#f6f6f6; }
    
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
    .page-header h1 { margin:0; }
    
    .form-section { background:#f8fafc; padding:1.5rem; border-radius:8px; margin-bottom:1.5rem; }
    .form-section h2 { margin:0 0 1rem 0; color:#4b2f6f; font-size:1.2rem; }
    
    .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    .form-full { grid-column:1 / -1; }
    
    label { display:block; margin-top:0.75rem; font-weight:600; font-size:0.9rem; color:#333; }
    input[type="text"], input[type="number"], textarea, select { 
      width:100%; 
      padding:0.6rem; 
      margin-top:0.25rem; 
      border-radius:6px; 
      border:1px solid #ddd; 
      font-family:inherit;
      font-size:0.95rem;
    }
    textarea { resize:vertical; }
    
    .image-preview-grid { 
      display:grid; 
      grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); 
      gap:1rem; 
      margin:1rem 0;
    }
    .image-preview-item { 
      position:relative; 
      border:2px solid #e5e7eb; 
      border-radius:8px; 
      overflow:hidden;
      background:#fff;
    }
    .image-preview-item img { 
      width:100%; 
      height:150px; 
      object-fit:cover; 
      display:block;
    }
    .image-preview-badge { 
      position:absolute; 
      top:8px; 
      left:8px; 
      background:rgba(0,0,0,0.7); 
      color:#fff; 
      padding:0.25rem 0.5rem; 
      border-radius:4px; 
      font-size:0.75rem; 
      font-weight:600;
    }
    .image-preview-primary { border-color:#6e33b7; border-width:3px; }
    .image-preview-controls {
      position:absolute;
      bottom:0;
      left:0;
      right:0;
      display:flex;
      gap:0.25rem;
      padding:0.5rem;
      background:rgba(0,0,0,0.5);
      opacity:0;
      transition:opacity 0.2s;
    }
    .image-preview-item:hover .image-preview-controls {
      opacity:1;
    }
    .image-preview-controls button {
      flex:1;
      padding:0.25rem;
      border:none;
      border-radius:4px;
      background:#fff;
      color:#333;
      font-size:0.75rem;
      font-weight:600;
      cursor:pointer;
      transition:background 0.2s;
    }
    .image-preview-controls button:hover {
      background:#f0f0f0;
    }
    .image-preview-controls button:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    .image-preview-controls .btn-danger {
      background:#ef4444;
      color:#fff;
    }
    .image-preview-controls .btn-danger:hover {
      background:#dc2626;
    }
    
    .button-group { display:flex; gap:0.75rem; margin-top:2rem; flex-wrap:wrap; }
    .btn { 
      padding:0.75rem 1.5rem; 
      border-radius:8px; 
      border:none; 
      font-weight:600; 
      cursor:pointer; 
      font-size:0.95rem;
      transition: all 0.2s;
    }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-primary { background:#6e33b7; color:#fff; }
    .btn-primary:hover:not(:disabled) { background:#5a2a96; }
    .btn-secondary { background:#10b981; color:#fff; }
    .btn-secondary:hover:not(:disabled) { background:#059669; }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-danger:hover:not(:disabled) { background:#dc2626; }
    .btn-outline { background:#fff; color:#333; border:2px solid #ddd; }
    .btn-outline:hover:not(:disabled) { background:#f9fafb; border-color:#999; }
    
    .alert { padding:1rem; border-radius:8px; margin-bottom:1rem; }
    .alert-success { background:#d1fae5; color:#065f46; border:1px solid #10b981; }
    .alert-error { background:#fee2e2; color:#991b1b; border:1px solid #ef4444; }
    .alert-info { background:#dbeafe; color:#1e40af; border:1px solid #3b82f6; }
    
    .loading { text-align:center; padding:2rem; color:#666; }
    .loading::after { content:'...'; animation:dots 1.5s steps(4,end) infinite; }
    @keyframes dots { 0%, 20% { content:'.'; } 40% { content:'..'; } 60%, 100% { content:'...'; } }
    
    .help-text { font-size:0.85rem; color:#6b7280; margin-top:0.25rem; font-weight:normal; }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/img/logo.png" alt="Bonnie Lass Florals Logo" style="height:48px;vertical-align:middle;">
      Bonnie Lass Florals
    </div>

    <nav>
      <a href="/index.html">Home</a>
      <a href="/about.html">About</a>
      <a href="/shop.html">Shop</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/contact.html">Contact</a>
    </nav>

    <!-- Profile circle + dropdown -->
    <div id="profileCircleContainer">
      <img id="profileCircle" src="/img/default-avatar.png" alt="Profile" style="height:40px;width:40px;border-radius:50%;cursor:pointer;" />
      <div id="profileDropdown">
        <div id="userInfoDropdown" style="padding:0.75rem;border-bottom:1px solid #f0f0f0;"></div>
        <a href="/profile.html">Profile</a>
        <a href="/orders.html">Orders</a>
        <a id="adminOrdersLink" href="/admin/orders.html" style="display:none;">All Orders (Admin)</a>
        <a id="uploadProductLink" href="/admin/upload.html" style="display:none;">Upload Product</a>
        <a id="paletteLink" href="/admin/palette.html" style="display:none;">Palette Editor</a>
        <a id="messagesLink" href="/admin/messages.html" style="display:none;">Messages</a>
        <button id="logoutMenu">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div style="font-size:0.95rem;color:#666;margin-bottom:0.75rem;">
      <a href="/index.html" style="color:#6e33b7;text-decoration:none;">Home</a> <span style="color:#bbb;margin:0 8px;">‚Ä∫</span>
      <a href="/profile.html" style="color:#6e33b7;text-decoration:none;">Profile</a> <span style="color:#bbb;margin:0 8px;">‚Ä∫</span>
      <a href="/admin/upload.html" style="color:#6e33b7;text-decoration:none;">Manage Products</a> <span style="color:#bbb;margin:0 8px;">‚Ä∫</span>
      <span style="font-weight:600;">Edit Product</span>
    </div>

    <div class="page-header">
      <h1 id="pageTitle">Edit Product</h1>
      <div>
        <button id="duplicateBtn" class="btn btn-secondary" style="display:none;">
          <span>üìã</span> Duplicate Product
        </button>
      </div>
    </div>

    <div id="loadingMessage" class="loading">Loading product data</div>
    <div id="errorMessage" class="alert alert-error" style="display:none;"></div>
    <div id="successMessage" class="alert alert-success" style="display:none;"></div>

    <form id="editProductForm" style="display:none;">
      <!-- Basic Information Section -->
      <section class="form-section">
        <h2>Basic Information</h2>
        <div class="form-grid">
          <div class="form-full">
            <label for="name">Product Name *</label>
            <input type="text" id="name" name="name" required data-history="product_name">
          </div>
          
          <div class="form-full">
            <label for="description">Description *</label>
            <textarea id="description" name="description" required rows="4" data-history="product_description"></textarea>
          </div>
          
          <div>
            <label for="price">Price ($) *</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required>
          </div>
          
          <div>
            <label for="stock">Stock Quantity *</label>
            <input type="number" id="stock" name="stock" min="0" required>
          </div>
          
          <div>
            <label for="type">Product Type *</label>
            <select id="type" name="type" required>
              <option value="decor">Handmade Crafts</option>
              <option value="food">Cottage Food</option>
            </select>
          </div>
          
          <div>
            <label for="subcategory">Subcategory</label>
            <input type="text" id="subcategory" name="subcategory" data-history="product_subcategory">
          </div>
          
          <div class="form-full">
            <label for="options">Product Options (comma-separated)</label>
            <input type="text" id="options" name="options" placeholder="e.g., Red, Blue, Large, Small" data-history="product_options">
            <div class="help-text">Enter different variants or options available for this product</div>
          </div>
          
          <div class="form-full">
            <label for="productGroup">Product Group (Optional)</label>
            <input type="text" id="productGroup" name="productGroup" list="productGroupList" placeholder="e.g., Sauces, Jams, Wreaths" data-history="product_group">
            <datalist id="productGroupList"></datalist>
            <div class="help-text">Group similar products together (e.g., different sauce flavors). Leave blank for standalone product.</div>
          </div>
        </div>
      </section>

      <!-- Images Section -->
      <section class="form-section">
        <h2>Product Images</h2>
        
        <div id="currentImagesContainer" style="display:none;">
          <label>Current Images</label>
          <div class="help-text" style="margin-bottom:0.5rem;">The first image is the primary product image. Hover over images to reorder or delete them.</div>
          <div id="currentImagesPreview" class="image-preview-grid"></div>
        </div>
        
        <div class="form-full" style="margin-top:1rem;">
          <label for="imageUrls">Add Image URLs (one per line)</label>
          <textarea id="imageUrls" name="imageUrls" rows="3" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg" data-history="product_image_urls"></textarea>
          <div class="help-text">Paste image URLs, one per line. These will be added to existing images.</div>
        </div>
        
        <div class="form-full">
          <label for="imageFiles">Or Upload New Images</label>
          <input type="file" id="imageFiles" name="imageFiles" accept="image/*" multiple>
          <div class="help-text">Select one or more image files to upload (JPEG, PNG, GIF, WebP - max 10MB each)</div>
          <div id="imageUploadProgress" style="margin-top:0.5rem;color:#666;"></div>
        </div>
      </section>

      <!-- Extended Details Section -->
      <section class="form-section">
        <h2>Extended Details (Optional)</h2>
        <div class="help-text" style="margin-bottom:1rem;">Add detailed information about the product. Useful for ingredients, recipes, care instructions, etc.</div>
        
        <div class="form-grid">
          <div class="form-full">
            <label for="ingredients">Ingredients</label>
            <textarea id="ingredients" name="ingredients" rows="2" placeholder="List of ingredients (for food items)" data-history="product_ingredients"></textarea>
          </div>
          
          <div>
            <label for="allergens">Allergen Information</label>
            <input type="text" id="allergens" name="allergens" placeholder="e.g., Contains nuts, dairy" data-history="product_allergens">
          </div>
          
          <div>
            <label for="dimensions">Dimensions</label>
            <input type="text" id="dimensions" name="dimensions" placeholder="e.g., 12in x 8in x 6in" data-history="product_dimensions">
          </div>
          
          <div class="form-full">
            <label for="nutritionalInfo">Nutritional Information</label>
            <textarea id="nutritionalInfo" name="nutritionalInfo" rows="3" placeholder="Per serving: calories, fat, protein, etc." data-history="product_nutritional"></textarea>
          </div>
          
          <div class="form-full">
            <label for="recipe">Recipe / Usage Instructions</label>
            <textarea id="recipe" name="recipe" rows="3" placeholder="How to use or prepare this product" data-history="product_recipe"></textarea>
          </div>
          
          <div class="form-full">
            <label for="careInstructions">Care Instructions</label>
            <textarea id="careInstructions" name="careInstructions" rows="2" placeholder="How to care for this product" data-history="product_care"></textarea>
          </div>
          
          <div>
            <label for="materials">Materials</label>
            <input type="text" id="materials" name="materials" placeholder="Materials used in this product" data-history="product_materials">
          </div>
          
          <div>
            <label for="weight">Weight</label>
            <input type="text" id="weight" name="weight" placeholder="e.g., 2 lbs, 500g" data-history="product_weight">
          </div>
          
          <div class="form-full">
            <label for="storageInstructions">Storage Instructions</label>
            <textarea id="storageInstructions" name="storageInstructions" rows="2" placeholder="How to store this product" data-history="product_storage"></textarea>
          </div>
          
          <div>
            <label for="expirationInfo">Expiration / Shelf Life</label>
            <input type="text" id="expirationInfo" name="expirationInfo" placeholder="e.g., Best within 30 days" data-history="product_expiration">
          </div>
          
          <div class="form-full">
            <label for="additionalNotes">Additional Notes</label>
            <textarea id="additionalNotes" name="additionalNotes" rows="2" placeholder="Any other relevant information" data-history="product_notes"></textarea>
          </div>
        </div>
      </section>

      <!-- Action Buttons -->
      <div class="button-group">
        <button type="submit" id="saveBtn" class="btn btn-primary">
          üíæ Save Changes
        </button>
        <button type="button" id="cancelBtn" class="btn btn-outline">
          ‚Üê Back to Products
        </button>
        <button type="button" id="deleteBtn" class="btn btn-danger" style="margin-left:auto;">
          üóëÔ∏è Delete Product
        </button>
      </div>
    </form>
  </main>

  <script>
    // API Configuration
    const API_BASE = (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
      ? 'http://localhost:5000'
      : 'https://bonnie-lass-florals.onrender.com';

    // Global variables
    let currentProduct = null;
    let productId = null;

    // Profile dropdown and auth handled by auth.js

    // Get product ID from URL
    function getProductIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    // Load product data
    async function loadProduct() {
      productId = getProductIdFromUrl();
      
      if (!productId) {
        showError('No product ID provided. Please select a product to edit.');
        document.getElementById('loadingMessage').style.display = 'none';
        return;
      }

      try {
        // Load all products to populate the product group datalist
        const allProductsResponse = await fetch(`${API_BASE}/api/products?limit=1000`);
        if (allProductsResponse.ok) {
          const payload = await allProductsResponse.json();
          const allProducts = Array.isArray(payload) ? payload : (payload.products || []);
          populateProductGroupDatalist(allProducts);
        }
        
        const response = await fetch(`${API_BASE}/api/products/${productId}`);
        
        if (!response.ok) {
          throw new Error('Product not found');
        }

        currentProduct = await response.json();
        populateForm(currentProduct);
        
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('editProductForm').style.display = 'block';
        document.getElementById('duplicateBtn').style.display = 'inline-block';
        
      } catch (err) {
        console.error('Error loading product:', err);
        showError('Failed to load product: ' + err.message);
        document.getElementById('loadingMessage').style.display = 'none';
      }
    }
    
    // Populate product group datalist with unique values from all products
    function populateProductGroupDatalist(products) {
      const productGroupList = document.getElementById('productGroupList');
      const productGroups = new Set();
      
      products.forEach(p => {
        if (p.productGroup && p.productGroup.trim()) {
          productGroups.add(p.productGroup.trim());
        }
      });
      
      // Clear existing options
      productGroupList.innerHTML = '';
      
      // Add product groups in alphabetical order
      Array.from(productGroups).sort().forEach(group => {
        const option = document.createElement('option');
        option.value = group;
        productGroupList.appendChild(option);
      });
    }

    // Populate form with product data
    function populateForm(product) {
      // Update page title
      document.getElementById('pageTitle').textContent = `Edit: ${product.name}`;
      
      // Basic fields
      document.getElementById('name').value = product.name || '';
      document.getElementById('description').value = product.description || '';
      document.getElementById('price').value = product.price || '';
      document.getElementById('stock').value = product.stock || 1;
      document.getElementById('type').value = product.type || 'decor';
      document.getElementById('subcategory').value = product.subcategory || '';
      document.getElementById('options').value = (product.options && product.options.join) 
        ? product.options.join(',') 
        : (product.options || '');
      document.getElementById('productGroup').value = product.productGroup || '';
      
      // Extended details
      const details = product.extendedDetails || {};
      document.getElementById('ingredients').value = details.ingredients || '';
      document.getElementById('allergens').value = details.allergens || '';
      document.getElementById('nutritionalInfo').value = details.nutritionalInfo || '';
      document.getElementById('recipe').value = details.recipe || '';
      document.getElementById('careInstructions').value = details.careInstructions || '';
      document.getElementById('dimensions').value = details.dimensions || '';
      document.getElementById('materials').value = details.materials || '';
      document.getElementById('weight').value = details.weight || '';
      document.getElementById('storageInstructions').value = details.storageInstructions || '';
      document.getElementById('expirationInfo').value = details.expirationInfo || '';
      document.getElementById('additionalNotes').value = details.additionalNotes || '';
      
      // Display current images
      const images = product.images || (product.image ? [product.image] : []);
      if (images.length > 0) {
        displayCurrentImages(images);
      }
      
      // Set image URLs for editing (keep existing)
      document.getElementById('imageUrls').value = '';
    }

    // Display current images with management controls
    function displayCurrentImages(images) {
      const container = document.getElementById('currentImagesContainer');
      const preview = document.getElementById('currentImagesPreview');
      
      if (!images || images.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'block';
      preview.innerHTML = images.map((img, idx) => `
        <div class="image-preview-item ${idx === 0 ? 'image-preview-primary' : ''}" data-image-index="${idx}">
          <img src="${escapeAttr(img)}" alt="Product image ${idx + 1}" onerror="this.src='/img/default-product.png'">
          <div class="image-preview-badge">${idx === 0 ? 'Primary' : `#${idx + 1}`}</div>
          <div class="image-preview-controls">
            <button type="button" onclick="moveImage(${idx}, -1)" ${idx === 0 ? 'disabled' : ''} title="Move left">‚óÑ</button>
            <button type="button" onclick="moveImage(${idx}, 1)" ${idx === images.length - 1 ? 'disabled' : ''} title="Move right">‚ñ∫</button>
            <button type="button" class="btn-danger" onclick="deleteImage(${idx})" title="Delete">√ó</button>
          </div>
        </div>
      `).join('');
    }

    // Upload image to Firebase Storage
    async function uploadImageToFirebase(file) {
      const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
      const MIN_FILENAME_LENGTH = 3;
      const MAX_FILENAME_LENGTH = 100;
      
      if (!ALLOWED_TYPES.includes(file.type)) {
        throw new Error('Invalid file type. Only JPEG, PNG, GIF, and WebP images are allowed.');
      }
      
      if (file.size > MAX_FILE_SIZE) {
        throw new Error('File size exceeds 10MB limit.');
      }
      
      const storage = firebase.storage();
      const storageRef = storage.ref();
      const timestamp = Date.now();
      
      let safeName = file.name
        .replace(/[^a-zA-Z0-9._-]/g, '_')
        .replace(/\.{2,}/g, '_')
        .replace(/^\.+/, '')
        .substring(0, MAX_FILENAME_LENGTH);
      
      if (!safeName || safeName.length < MIN_FILENAME_LENGTH) {
        const extension = file.type.split('/')[1] || 'jpg';
        safeName = `image.${extension}`;
      }
      
      const filename = `product-images/${timestamp}-${safeName}`;
      const imageRef = storageRef.child(filename);
      
      const metadata = {
        contentType: file.type,
        customMetadata: {
          uploadedAt: new Date().toISOString()
        }
      };
      
      const snapshot = await imageRef.put(file, metadata);
      const downloadURL = await snapshot.ref.getDownloadURL();
      return downloadURL;
    }

    // Save product changes
    async function saveProduct(e) {
      e.preventDefault();
      
      const user = firebase.auth().currentUser;
      if (!user) {
        showError('Please login first');
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      const progressEl = document.getElementById('imageUploadProgress');
      const originalBtnText = saveBtn.innerHTML;
      
      try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = 'üíæ Saving...';
        
        // Hide messages
        document.getElementById('successMessage').style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        progressEl.textContent = '';
        
        const token = await user.getIdToken();
        const imageUrls = [];
        
        // Keep existing images
        if (currentProduct.images && currentProduct.images.length > 0) {
          imageUrls.push(...currentProduct.images);
        }
        
        // Add new image URLs from textarea
        const newUrls = document.getElementById('imageUrls').value;
        if (newUrls.trim()) {
          const urls = newUrls
            .split(/[\n,]/)
            .map(url => url.trim())
            .filter(url => url && url.startsWith('http'));
          imageUrls.push(...urls);
        }
        
        // Upload new image files
        const fileInput = document.getElementById('imageFiles');
        if (fileInput.files && fileInput.files.length > 0) {
          const totalFiles = fileInput.files.length;
          
          for (let i = 0; i < totalFiles; i++) {
            const file = fileInput.files[i];
            saveBtn.innerHTML = `üì§ Uploading image ${i + 1}/${totalFiles}...`;
            progressEl.textContent = `Uploading image ${i + 1} of ${totalFiles}...`;
            
            try {
              const imageUrl = await uploadImageToFirebase(file);
              imageUrls.push(imageUrl);
            } catch (uploadErr) {
              console.error(`Failed to upload image ${i + 1}:`, uploadErr);
              progressEl.textContent = `Warning: Failed to upload image ${i + 1}. Continuing...`;
            }
          }
        }
        
        saveBtn.innerHTML = 'üíæ Saving product...';
        progressEl.textContent = 'Saving product...';
        
        // Build update payload
        const updateData = {
          name: document.getElementById('name').value,
          description: document.getElementById('description').value,
          price: document.getElementById('price').value,
          type: document.getElementById('type').value,
          subcategory: document.getElementById('subcategory').value,
          stock: document.getElementById('stock').value,
          options: document.getElementById('options').value,
          productGroup: document.getElementById('productGroup').value.trim() || '',
          images: imageUrls,
          extendedDetails: {
            ingredients: document.getElementById('ingredients').value || '',
            allergens: document.getElementById('allergens').value || '',
            nutritionalInfo: document.getElementById('nutritionalInfo').value || '',
            recipe: document.getElementById('recipe').value || '',
            careInstructions: document.getElementById('careInstructions').value || '',
            dimensions: document.getElementById('dimensions').value || '',
            materials: document.getElementById('materials').value || '',
            weight: document.getElementById('weight').value || '',
            storageInstructions: document.getElementById('storageInstructions').value || '',
            expirationInfo: document.getElementById('expirationInfo').value || '',
            additionalNotes: document.getElementById('additionalNotes').value || ''
          }
        };

        const response = await fetch(`${API_BASE}/api/products/${productId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updateData)
        });

        const data = await response.json();
        
        if (response.ok) {
          showSuccess('Product updated successfully! Redirecting...');
          progressEl.textContent = '';
          
          // Redirect back to upload page after a short delay
          setTimeout(() => {
            window.location.href = '/admin/upload.html';
          }, 1500);
        } else {
          throw new Error(data.error || 'Failed to update product');
        }
        
      } catch (err) {
        console.error('Error saving product:', err);
        showError('Failed to save product: ' + err.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
        progressEl.textContent = '';
      }
    }

    // Delete product
    async function deleteProduct() {
      if (!confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        return;
      }
      
      const user = firebase.auth().currentUser;
      if (!user) {
        showError('Please login first');
        return;
      }

      const deleteBtn = document.getElementById('deleteBtn');
      const originalBtnText = deleteBtn.innerHTML;
      
      try {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '‚è≥ Deleting...';
        
        const token = await user.getIdToken();
        
        const response = await fetch(`${API_BASE}/api/products/${productId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          showSuccess('Product deleted successfully! Redirecting...');
          setTimeout(() => {
            window.location.href = '/admin/upload.html';
          }, 1500);
        } else {
          const data = await response.json();
          throw new Error(data.error || 'Failed to delete product');
        }
        
      } catch (err) {
        console.error('Error deleting product:', err);
        showError('Failed to delete product: ' + err.message);
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalBtnText;
      }
    }

    // Duplicate product
    function duplicateProduct() {
      if (!currentProduct) return;
      
      // Store product data in sessionStorage
      const duplicateData = {
        ...currentProduct,
        name: currentProduct.name + ' (Copy)',
        _id: undefined // Remove ID so it creates a new product
      };
      
      sessionStorage.setItem('duplicateProduct', JSON.stringify(duplicateData));
      
      // Redirect to upload page which will populate the form
      window.location.href = '/admin/upload.html?action=duplicate';
    }

    // Cancel and go back
    function cancelEdit() {
      if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = '/admin/upload.html';
      }
    }

    // Show error message
    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      document.getElementById('successMessage').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Show success message
    function showSuccess(message) {
      const successEl = document.getElementById('successMessage');
      successEl.textContent = message;
      successEl.style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // HTML escaping utilities
    function escapeHtml(s) {
      if (!s && s !== 0) return '';
      const div = document.createElement('div');
      div.textContent = String(s);
      return div.innerHTML;
    }
    
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, '&quot;');
    }

    // Image management functions
    function moveImage(index, direction) {
      if (!currentProduct || !currentProduct.images) return;
      
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= currentProduct.images.length) return;
      
      // Swap images
      const images = [...currentProduct.images];
      [images[index], images[newIndex]] = [images[newIndex], images[index]];
      currentProduct.images = images;
      
      // Update display
      displayCurrentImages(images);
    }

    function deleteImage(index) {
      if (!currentProduct || !currentProduct.images) return;
      
      if (!confirm('Are you sure you want to delete this image?')) return;
      
      // Remove image from array
      const images = [...currentProduct.images];
      images.splice(index, 1);
      currentProduct.images = images;
      
      // Update display
      displayCurrentImages(images);
      
      // Show message if no images left
      if (images.length === 0) {
        showError('All images removed. Please add at least one image before saving.');
      }
    }

    // Event listeners
    document.getElementById('editProductForm').addEventListener('submit', saveProduct);
    document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
    document.getElementById('deleteBtn').addEventListener('click', deleteProduct);
    document.getElementById('duplicateBtn').addEventListener('click', duplicateProduct);

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadProduct();
    });
  </script>

  <script src="/ui-utils.js"></script>
  <script src="/mobile-nav.js"></script>
  <script src="/auth.js"></script>
</body>
</html>
